{
  "policyUpi": "",
  "policyId": "edf08e81-3014-4750-9b88-0a194dfe8a4e",
  "policyType": "iam",
  "cloudType": "azure",
  "severity": "medium",
  "name": "Azure Lateral Movement Through SSH Key Replacement and Managed Identity Exploitation on VM",
  "description": "Using this role allows creating and changing virtual machines in the subscription, with 'Microsoft.ClassicCompute/virtualMachines/write' and 'Microsoft.ClassicCompute/virtualMachines/extensions/write' an adversary can update SSH keys for a given VM in the subscription and hijack the resource",
  "rule.criteria": "edf08e81-3014-4750-9b88-0a194dfe8a4e",
  "searchModel.query": "config from iam where dest.cloud.type = 'AZURE' AND action.name CONTAINS ALL ('Microsoft.ClassicCompute/virtualMachines/write', 'Microsoft.ClassicCompute/virtualMachines/extensions/write') AND grantedby.cloud.entity.type IN ( 'user assigned', 'system assigned', 'service principal', 'user') AND grantedby.level.type = 'Azure Subscription' ",
  "recommendation": "Remediation steps:\n 1. Sign in to Azure Management Console\n 2. Navigate to Azure Subscriptions blade at https://portal.azure.com/#blade/Microsoft_Azure_Billing/SubscriptionsBlade\n 3. Click on the Azure cloud subscription that you want to examine\n 4. In the navigation panel, choose Access control (IAM) and select the Role Assignments tab to access the role bindings available for the selected subscription\n 5. Find the assignment between the azure identity and the role with permissions to Microsoft.ClassicCompute\n 6. Remove the assignment or change the permissions of the role\n 7. Create a new assignment with built-in or custom role without risky permissions and/or scoped down to only VMs that this identity requires access to, if necessary",
  "remediable": true,
  "remediation.cliScriptTemplate": "dynamic Azure cli commands",
  "remediation.description": "List of CLI commands are generated dynamically based on the violating resource. Successful execution will limit the relevant permissions of the violating resource.",
  "remediation.impact": "limit the relevant permissions of the violating resource",
  "compliance.standard": ""
}